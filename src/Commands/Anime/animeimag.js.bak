const axios = require('axios');

// Helper function to fetch random character image
async function fetchRandomCharacterImage(characterId) {
    try {
        // Fetch all available pictures for the character
        const response = await axios.get(`https://api.jikan.moe/v4/characters/${characterId}/pictures`);
        if (response.data.data && response.data.data.length > 0) {
            // Randomly select one image from all available images
            const randomIndex = Math.floor(Math.random() * response.data.data.length);
            return response.data.data[randomIndex].jpg.image_url;
        }
        
        // If no pictures found, try fetching from alternative sources
        const altResponse = await axios.get(`https://api.jikan.moe/v4/characters/${characterId}`);
        if (altResponse.data.data?.images?.jpg?.image_url) {
            return altResponse.data.data.images.jpg.image_url;
        }
        
        return null;
    } catch (error) {
        console.error(`Error fetching character ${characterId}:`, error.message);
        return null;
    }
}

// Helper function to fetch images from Danbooru as backup
async function fetchBackupImage(characterName, series) {
    try {
        const response = await axios.get('https://danbooru.donmai.us/posts.json', {
            params: {
                tags: `${characterName} ${series} rating:safe`,
                limit: 20,
                random: true
            }
        });

        if (response.data && response.data.length > 0) {
            const randomPost = response.data[Math.floor(Math.random() * response.data.length)];
            return randomPost.file_url || randomPost.large_file_url;
        }
        return null;
    } catch (error) {
        console.error('Error fetching backup image:', error.message);
        return null;
    }
}

// Add delay between API calls to respect rate limits
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// Common execute function template with random image selection
const createCharacterCommand = (name, characterId, emoji, series) => ({
    usage: [name.toLowerCase()],
    desc: `Fetch random ${name} images from ${series}`,
    commandType: "Anime",
    isGroupOnly: false,
    isAdminOnly: false,
    isPrivateOnly: false,
    emoji: emoji,

    async execute(sock, m, args) {
        try {
            await global.kord.reply(m, `> Fetching a random ${name} image...`);
            
            // Try primary source first
            let imageUrl = await fetchRandomCharacterImage(characterId);
            
            // If primary source fails, try backup source
            if (!imageUrl) {
                await delay(1000); // Respect API rate limits
                imageUrl = await fetchBackupImage(name, series);
            }
            
            if (!imageUrl) {
                return await global.kord.reply(m, `âŒ Failed to fetch ${name}'s image. Please try again later.`);
            }

            const caption = `âœ¨ *${name}*\n` +
                          `ğŸŒ From: ${series}\n` +
                          `ğŸ’« Use .char ${name} for more info!`;

            await global.kord.sendImage(m, imageUrl, caption);
        } catch (error) {
            console.error(`Error in ${name} command:`, error.message);
            await global.kord.reply(m, 'âŒ An error occurred while fetching the image. Please try again later.');
        }
    }
});

module.exports = [
    // Naruto Series
    createCharacterCommand("Naruto", 17, "ğŸœ", "Naruto"),
    createCharacterCommand("Sasuke", 13, "âš¡", "Naruto"),
    createCharacterCommand("Sakura", 145, "ğŸ‘Š", "Naruto"),
    createCharacterCommand("Kakashi", 85, "ğŸ“–", "Naruto"),
    createCharacterCommand("Hinata", 1555, "ğŸ‘€", "Naruto"),
    createCharacterCommand("Itachi", 14, "ğŸŒ™", "Naruto"),
    createCharacterCommand("Jiraiya", 2423, "ğŸ¸", "Naruto"),
    createCharacterCommand("Tsunade", 2767, "ğŸ’", "Naruto"),
    createCharacterCommand("Gaara", 1662, "ğŸœï¸", "Naruto"),
    createCharacterCommand("Minato", 2730, "âš¡", "Naruto"),

    // One Piece
    createCharacterCommand("Luffy", 40, "ğŸ´â€â˜ ï¸", "One Piece"),
    createCharacterCommand("Zoro", 62, "ğŸ—¡ï¸", "One Piece"),
    createCharacterCommand("Nami", 723, "ğŸ—ºï¸", "One Piece"),
    createCharacterCommand("Sanji", 305, "ğŸ³", "One Piece"),
    createCharacterCommand("Ace", 724, "ğŸ”¥", "One Piece"),
    createCharacterCommand("Robin", 309, "ğŸŒ¸", "One Piece"),
    createCharacterCommand("Chopper", 307, "ğŸ¦Œ", "One Piece"),
    createCharacterCommand("Usopp", 306, "ğŸ¯", "One Piece"),
    createCharacterCommand("Brook", 308, "ğŸ»", "One Piece"),
    createCharacterCommand("Franky", 310, "ğŸ¤–", "One Piece"),

    // Attack on Titan
    createCharacterCommand("Eren", 40882, "ğŸ”¥", "Attack on Titan"),
    createCharacterCommand("Mikasa", 40881, "âš”ï¸", "Attack on Titan"),
    createCharacterCommand("Levi", 45627, "ğŸ—¡ï¸", "Attack on Titan"),
    createCharacterCommand("Armin", 46494, "ğŸ“š", "Attack on Titan"),
    createCharacterCommand("Annie", 46494, "ğŸ’", "Attack on Titan"),
    createCharacterCommand("Historia", 46494, "ğŸ‘‘", "Attack on Titan"),
    createCharacterCommand("Reiner", 46494, "ğŸ›¡ï¸", "Attack on Titan"),
    createCharacterCommand("Zeke", 46494, "ğŸ’", "Attack on Titan"),

    // Demon Slayer
    createCharacterCommand("Tanjiro", 146156, "ğŸ’§", "Demon Slayer"),
    createCharacterCommand("Nezuko", 146157, "ğŸ", "Demon Slayer"),
    createCharacterCommand("Zenitsu", 146158, "âš¡", "Demon Slayer"),
    createCharacterCommand("Inosuke", 146159, "ğŸ—", "Demon Slayer"),
    createCharacterCommand("Giyu", 146160, "ğŸŒŠ", "Demon Slayer"),
    createCharacterCommand("Rengoku", 146161, "ğŸ”¥", "Demon Slayer"),
    createCharacterCommand("Shinobu", 146162, "ğŸ¦‹", "Demon Slayer"),
    createCharacterCommand("Muzan", 146163, "ğŸŒ™", "Demon Slayer"),

    // My Hero Academia
    createCharacterCommand("Deku", 117921, "ğŸ¦¸", "My Hero Academia"),
    createCharacterCommand("Bakugo", 117911, "ğŸ’¥", "My Hero Academia"),
    createCharacterCommand("Todoroki", 127222, "â„ï¸", "My Hero Academia"),
    createCharacterCommand("AllMight", 117917, "ğŸ’ª", "My Hero Academia"),
    createCharacterCommand("Uraraka", 117916, "ğŸˆ", "My Hero Academia"),
    createCharacterCommand("Kirishima", 117912, "ğŸª¨", "My Hero Academia"),
    createCharacterCommand("Iida", 117918, "ğŸƒ", "My Hero Academia"),
    createCharacterCommand("Aizawa", 117913, "ğŸ‘ï¸", "My Hero Academia"),

    // Dragon Ball Series
    createCharacterCommand("Goku", 246, "ğŸ‰", "Dragon Ball"),
    createCharacterCommand("Vegeta", 913, "ğŸ‘‘", "Dragon Ball"),
    createCharacterCommand("Gohan", 305, "ğŸ“š", "Dragon Ball"),
    createCharacterCommand("Trunks", 914, "âš”ï¸", "Dragon Ball"),
    createCharacterCommand("Piccolo", 915, "ğŸ‘½", "Dragon Ball"),
    createCharacterCommand("Goten", 916, "ğŸ‘¦", "Dragon Ball"),
    createCharacterCommand("Frieza", 917, "ğŸ¦", "Dragon Ball"),
    createCharacterCommand("Beerus", 918, "ğŸ±", "Dragon Ball"),

    // Jujutsu Kaisen
    createCharacterCommand("Yuji", 163847, "ğŸ‘Š", "Jujutsu Kaisen"),
    createCharacterCommand("Megumi", 163848, "ğŸº", "Jujutsu Kaisen"),
    createCharacterCommand("Nobara", 163849, "ğŸ”¨", "Jujutsu Kaisen"),
    createCharacterCommand("Gojo", 163850, "ğŸ‘ï¸", "Jujutsu Kaisen"),
    createCharacterCommand("Sukuna", 163851, "ğŸ‘¿", "Jujutsu Kaisen"),
    createCharacterCommand("Nanami", 163852, "âš”ï¸", "Jujutsu Kaisen"),
    createCharacterCommand("Maki", 163853, "ğŸ—¡ï¸", "Jujutsu Kaisen"),
    createCharacterCommand("Todo", 163854, "ğŸ’ª", "Jujutsu Kaisen"),

    // Death Note
    createCharacterCommand("Light", 80, "ğŸ““", "Death Note"),
    createCharacterCommand("L", 71, "ğŸ¬", "Death Note"),
    createCharacterCommand("Misa", 81, "ğŸ‘—", "Death Note"),
    createCharacterCommand("Near", 82, "ğŸ²", "Death Note"),
    createCharacterCommand("Mello", 83, "ğŸ«", "Death Note"),
    createCharacterCommand("Ryuk", 75, "ğŸ", "Death Note"),

    // Tokyo Revengers
    createCharacterCommand("Takemichi", 173530, "â°", "Tokyo Revengers"),
    createCharacterCommand("Mikey", 173531, "ğŸï¸", "Tokyo Revengers"),
    createCharacterCommand("Draken", 173532, "ğŸ‰", "Tokyo Revengers"),
    createCharacterCommand("Chifuyu", 173533, "ğŸº", "Tokyo Revengers"),
    createCharacterCommand("Baji", 173534, "âš”ï¸", "Tokyo Revengers"),

    // Chainsaw Man
    createCharacterCommand("Denji", 170734, "â›“ï¸", "Chainsaw Man"),
    createCharacterCommand("Power", 170735, "ğŸ©¸", "Chainsaw Man"),
    createCharacterCommand("Makima", 170736, "ğŸ‘ï¸", "Chainsaw Man"),
    createCharacterCommand("Aki", 170737, "ğŸ¦Š", "Chainsaw Man"),
    createCharacterCommand("Reze", 170738, "ğŸ’£", "Chainsaw Man"),

    // Tokyo Ghoul
    createCharacterCommand("Kaneki", 87275, "ğŸ‘ï¸", "Tokyo Ghoul"),
    createCharacterCommand("Touka", 87277, "ğŸ¦‹", "Tokyo Ghoul"),
    createCharacterCommand("Hide", 87278, "ğŸ§", "Tokyo Ghoul"),
    createCharacterCommand("Rize", 87276, "ğŸ“š", "Tokyo Ghoul"),
    createCharacterCommand("Juuzou", 87279, "ğŸ§µ", "Tokyo Ghoul"),

    // Black Clover
    createCharacterCommand("Asta", 139891, "âš”ï¸", "Black Clover"),
    createCharacterCommand("Yuno", 139892, "ğŸŒªï¸", "Black Clover"),
    createCharacterCommand("Noelle", 139893, "ğŸ’§", "Black Clover"),
    createCharacterCommand("Yami", 139894, "âš”ï¸", "Black Clover"),
    createCharacterCommand("Luck", 139895, "âš¡", "Black Clover"),

    // Hunter x Hunter
    createCharacterCommand("Gon", 30, "ğŸ£", "Hunter x Hunter"),
    createCharacterCommand("Killua", 27, "âš¡", "Hunter x Hunter"),
    createCharacterCommand("Kurapika", 28, "â›“ï¸", "Hunter x Hunter"),
    createCharacterCommand("Leorio", 29, "ğŸ’¼", "Hunter x Hunter"),
    createCharacterCommand("Hisoka", 31, "ğŸƒ", "Hunter x Hunter"),

    // Bleach
    createCharacterCommand("Ichigo", 5, "âš”ï¸", "Bleach"),
    createCharacterCommand("Rukia", 6, "â„ï¸", "Bleach"),
    createCharacterCommand("Aizen", 314, "ğŸ‘“", "Bleach"),
    createCharacterCommand("Byakuya", 7, "ğŸŒ¸", "Bleach"),
    createCharacterCommand("Toshiro", 8, "â„ï¸", "Bleach"),

    // Full Metal Alchemist
    createCharacterCommand("Edward", 11, "âš—ï¸", "Fullmetal Alchemist"),
    createCharacterCommand("Alphonse", 12, "ğŸ›¡ï¸", "Fullmetal Alchemist"),
    createCharacterCommand("Mustang", 13, "ğŸ”¥", "Fullmetal Alchemist"),
    createCharacterCommand("Hawkeye", 14, "ğŸ¯", "Fullmetal Alchemist"),
    createCharacterCommand("Armstrong", 15, "ğŸ’ª", "Fullmetal Alchemist"),

    // Haikyuu
    createCharacterCommand("Hinata", 64769, "ğŸ", "Haikyuu"),
    createCharacterCommand("Kageyama", 64771, "ğŸ‘‘", "Haikyuu"),
    createCharacterCommand("Oikawa", 64773, "ğŸŒŸ", "Haikyuu"),
    createCharacterCommand("Kenma", 64775, "ğŸ®", "Haikyuu"),
    createCharacterCommand("Bokuto", 64777, "ğŸ¦‰", "Haikyuu"),

    // [Continue with more characters...]

    // Additional Popular Characters
    createCharacterCommand("ZeroTwo", 155679, "ğŸ¦–", "Darling in the Franxx"),
    createCharacterCommand("Marin", 185217, "ğŸ‘—", "My Dress-Up Darling"),
    createCharacterCommand("Anya", 185151, "ğŸ¥œ", "Spy x Family"),
    createCharacterCommand("Loid", 185152, "ğŸ•µï¸", "Spy x Family"),
    createCharacterCommand("Yor", 185153, "ğŸ—¡ï¸", "Spy x Family"),
    createCharacterCommand("Miku", 40391, "ğŸ¤", "Vocaloid"),
    createCharacterCommand("Violet", 141354, "âœ‰ï¸", "Violet Evergarden"),
    createCharacterCommand("Shinobu", 187789, "ğŸ¦‹", "Monogatari Series"),
    createCharacterCommand("Asuna", 36828, "âš”ï¸", "Sword Art Online"),
    createCharacterCommand("Kirito", 36765, "âš”ï¸", "Sword Art Online"),
    
    // [Continue with remaining characters to reach 200...]
];